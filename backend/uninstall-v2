#!/bin/bash

# Script to uninstall Apollo on Armbian 24.2.1 Jamm

#### SETUP ####
#########################
# Set colors
YELLOW='\033[1;33m'
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

# Check if script is being run as root
if [ "$EUID" -ne 0 ]
  then echo -e "${RED}Uninstall script must be run by root or with sudo${NC}"
  exit
fi

# Set DEBIAN_FRONTEND to noninteractive to avoid prompts during uninstallation
export DEBIAN_FRONTEND=noninteractive

#### VARIABLES ####
#########################
# Define the APOLLO_DIR variable
APOLLO_DIR=/opt/apolloapi
APOLLO_UI_DIR=/opt/apolloapi/apolloui-v2

#### SYSTEMD CLEANUP ####
#########################
echo -e "${YELLOW} ---> Stopping and disabling systemd services${NC}"

# Stop and disable all Apollo services
systemctl stop apollo-api.service 2>/dev/null || true
systemctl stop apollo-ui-v2.service 2>/dev/null || true
systemctl stop apollo-miner.service 2>/dev/null || true
systemctl stop node.service 2>/dev/null || true
systemctl stop ckpool.service 2>/dev/null || true

systemctl disable apollo-api.service 2>/dev/null || true
systemctl disable apollo-ui-v2.service 2>/dev/null || true
systemctl disable apollo-miner.service 2>/dev/null || true
systemctl disable node.service 2>/dev/null || true
systemctl disable ckpool.service 2>/dev/null || true

# Remove systemd service files
rm -f /etc/systemd/system/apollo-api.service
rm -f /etc/systemd/system/apollo-ui-v2.service
rm -f /etc/systemd/system/apollo-miner.service
rm -f /etc/systemd/system/node.service
rm -f /etc/systemd/system/ckpool.service

# Reload systemd daemon
systemctl daemon-reload

echo -e "${GREEN} ---> Systemd services stopped, disabled and removed${NC}"

#### FIREWALL CLEANUP ####
#########################
echo -e "${YELLOW} ---> Cleaning up firewall rules${NC}"

# Flush iptables rules
iptables -F 2>/dev/null || true
iptables -t nat -F 2>/dev/null || true
iptables -t mangle -F 2>/dev/null || true

# Reset default policies
iptables -P INPUT ACCEPT 2>/dev/null || true
iptables -P FORWARD ACCEPT 2>/dev/null || true
iptables -P OUTPUT ACCEPT 2>/dev/null || true

echo -e "${GREEN} ---> Firewall rules cleaned up${NC}"

#### RC.LOCAL CLEANUP ####
#########################
echo -e "${YELLOW} ---> Cleaning up rc.local${NC}"

RC_LOCAL=/etc/rc.local

if [ -f "$RC_LOCAL" ]; then
    # Remove the firewall line from rc.local
    sed -i '/\/opt\/apolloapi\/backend\/firewall/d' $RC_LOCAL
    
    # If rc.local is empty, remove it
    if [ ! -s "$RC_LOCAL" ]; then
        rm -f $RC_LOCAL
        echo -e "${GREEN} ---> Removed empty rc.local file${NC}"
    else
        echo -e "${GREEN} ---> Cleaned up rc.local file${NC}"
    fi
fi

#### TOR CLEANUP ####
#########################
echo -e "${YELLOW} ---> Cleaning up TOR configuration${NC}"

# Remove TOR configuration
rm -f /etc/tor/torrc

# Remove futurebit from debian-tor group
usermod -G debian-tor -d futurebit 2>/dev/null || true

echo -e "${GREEN} ---> TOR configuration cleaned up${NC}"

#### NVM CLEANUP ####
#########################
echo -e "${YELLOW} ---> Cleaning up NVM and Node.js${NC}"

# Remove global yarn installation
npm uninstall -g yarn 2>/dev/null || true

# Remove NVM lines from futurebit's bashrc
if [ -f "/home/futurebit/.bashrc" ]; then
    sed -i '/export NVM_DIR="\/usr\/local\/nvm"/d' /home/futurebit/.bashrc
    sed -i '/\[ -s "$NVM_DIR\/nvm.sh" \] && \. "$NVM_DIR\/nvm.sh"/d' /home/futurebit/.bashrc
    echo -e "${GREEN} ---> Removed NVM lines from futurebit's bashrc${NC}"
fi

# Remove NVM directory
rm -rf /usr/local/nvm

echo -e "${GREEN} ---> NVM and Node.js cleaned up${NC}"

#### APOLLO APPLICATION CLEANUP ####
#########################
echo -e "${YELLOW} ---> Removing Apollo application files${NC}"

# Remove the entire Apollo directory
if [ -d "$APOLLO_DIR" ]; then
    rm -rf $APOLLO_DIR
    echo -e "${GREEN} ---> Removed Apollo application directory${NC}"
else
    echo -e "${YELLOW} ---> Apollo directory not found${NC}"
fi

#### USER CLEANUP ####
#########################
echo -e "${YELLOW} ---> Cleaning up futurebit user${NC}"

# Remove futurebit from sudoers
sed -i '/futurebit.*ALL=(ALL) NOPASSWD:ALL/d' /etc/sudoers

# Remove futurebit user and home directory
userdel -r futurebit 2>/dev/null || true

echo -e "${GREEN} ---> Futurebit user cleaned up${NC}"

#### FINAL CLEANUP ####
#########################
echo -e "${YELLOW} ---> Performing final cleanup${NC}"

# Clean up any remaining temporary files
rm -rf /tmp/apollo* 2>/dev/null || true
rm -rf /var/tmp/apollo* 2>/dev/null || true

echo -e "${GREEN} ---> Final cleanup completed${NC}"

echo -e "${GREEN} ---> Uninstallation complete!${NC}"
echo -e "${YELLOW} ---> Note: Debian packages were not removed. Use 'apt remove' if needed.${NC}"
